# Deploy Workflow
#
# This workflow handles production deployments for:
# - Web app (Expo Web) → Vercel/Netlify/Cloudflare
# - Mobile app → EAS Build + Submit
# - Marketing site → Vercel/Netlify
#
# Prerequisites:
# 1. Set up required secrets in GitHub Settings → Secrets:
#    - EXPO_TOKEN: Your Expo access token (from expo.dev)
#    - VERCEL_TOKEN: Vercel deployment token (optional)
#    - VERCEL_ORG_ID: Vercel organization ID (optional)
#    - VERCEL_PROJECT_ID: Vercel project ID (optional)
#
# 2. Configure EAS:
#    - Run `eas build:configure` in apps/app
#    - Set up app credentials in EAS dashboard
#
# Usage:
# - Push to main branch → Auto-deploy web + marketing
# - Create GitHub Release → Build + submit mobile apps
# - Manual trigger → Select what to deploy

name: Deploy

on:
  push:
    branches:
      - main
    paths:
      # Only deploy when relevant files change
      - "apps/app/**"
      - "apps/web/**"
      - "packages/**"
      - "package.json"
      - "yarn.lock"

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      deploy_web:
        description: "Deploy web app"
        type: boolean
        default: true
      deploy_marketing:
        description: "Deploy marketing site"
        type: boolean
        default: true
      deploy_ios:
        description: "Build & submit iOS"
        type: boolean
        default: false
      deploy_android:
        description: "Build & submit Android"
        type: boolean
        default: false
      eas_profile:
        description: "EAS build profile"
        type: choice
        options:
          - production
          - preview
        default: production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # Don't cancel deploys in progress

env:
  EXPO_PUBLIC_APP_ENV: production

jobs:
  # ============================================
  # Web App Deployment (Expo Web → Vercel)
  # ============================================
  deploy-web:
    name: Deploy Web App
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_web)
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Web App
        run: yarn app:web:build
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
          EXPO_PUBLIC_POSTHOG_KEY: ${{ secrets.EXPO_PUBLIC_POSTHOG_KEY }}
          EXPO_PUBLIC_REVENUECAT_IOS_KEY: ${{ secrets.EXPO_PUBLIC_REVENUECAT_IOS_KEY }}
          EXPO_PUBLIC_REVENUECAT_ANDROID_KEY: ${{ secrets.EXPO_PUBLIC_REVENUECAT_ANDROID_KEY }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.EXPO_PUBLIC_SENTRY_DSN }}

      # Option 1: Deploy to Vercel
      - name: Deploy to Vercel
        id: deploy
        if: ${{ env.HAS_VERCEL_TOKEN == 'true' }}
        uses: amondnet/vercel-action@v25
        env:
          HAS_VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN != '' }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/app
          vercel-args: "--prod"

      # Option 2: Upload artifact for manual deployment
      - name: Upload build artifact
        if: ${{ env.HAS_VERCEL_TOKEN != 'true' }}
        env:
          HAS_VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: web-app-build
          path: apps/app/dist
          retention-days: 30

  # ============================================
  # Marketing Site Deployment
  # ============================================
  deploy-marketing:
    name: Deploy Marketing Site
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_marketing)
    environment:
      name: marketing
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Marketing Site
        run: yarn marketing:build

      # Deploy to Vercel (if configured)
      - name: Deploy to Vercel
        id: deploy
        if: ${{ env.HAS_VERCEL_MARKETING == 'true' }}
        uses: amondnet/vercel-action@v25
        env:
          HAS_VERCEL_MARKETING: ${{ secrets.VERCEL_MARKETING_PROJECT_ID != '' }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_MARKETING_PROJECT_ID }}
          working-directory: apps/web
          vercel-args: "--prod"

      - name: Upload build artifact
        if: ${{ env.HAS_VERCEL_MARKETING != 'true' }}
        env:
          HAS_VERCEL_MARKETING: ${{ secrets.VERCEL_MARKETING_PROJECT_ID != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: marketing-site-build
          path: apps/web/.next
          retention-days: 30

  # ============================================
  # iOS Build & Submit (EAS)
  # ============================================
  deploy-ios:
    name: Build & Submit iOS
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_ios)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build iOS
        working-directory: apps/app
        run: |
          PROFILE=${{ inputs.eas_profile || 'production' }}
          eas build --platform ios --profile $PROFILE --non-interactive

      - name: Submit to App Store
        if: github.event_name == 'release'
        working-directory: apps/app
        run: eas submit --platform ios --latest --non-interactive

  # ============================================
  # Android Build & Submit (EAS)
  # ============================================
  deploy-android:
    name: Build & Submit Android
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_android)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Android
        working-directory: apps/app
        run: |
          PROFILE=${{ inputs.eas_profile || 'production' }}
          eas build --platform android --profile $PROFILE --non-interactive

      - name: Submit to Play Store
        if: github.event_name == 'release'
        working-directory: apps/app
        run: eas submit --platform android --latest --non-interactive

  # ============================================
  # Deployment Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-marketing, deploy-ios, deploy-android]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy-web.result }}" == "success" ]]; then
            echo "✅ Web App: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-web.result }}" == "skipped" ]]; then
            echo "⏭️ Web App: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Web App: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-marketing.result }}" == "success" ]]; then
            echo "✅ Marketing: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-marketing.result }}" == "skipped" ]]; then
            echo "⏭️ Marketing: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Marketing: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-ios.result }}" == "success" ]]; then
            echo "✅ iOS: Built and submitted" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-ios.result }}" == "skipped" ]]; then
            echo "⏭️ iOS: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ iOS: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-android.result }}" == "success" ]]; then
            echo "✅ Android: Built and submitted" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-android.result }}" == "skipped" ]]; then
            echo "⏭️ Android: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Android: Failed" >> $GITHUB_STEP_SUMMARY
          fi
